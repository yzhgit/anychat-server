# Redis 配置 - AnyChat IM 系统
# 文档: https://redis.io/docs/management/config/

# ===== 网络 =====
bind 0.0.0.0
port 6379
tcp-backlog 511
# 空闲连接超时（秒），0=不超时
timeout 300
tcp-keepalive 300

# ===== 通用 =====
daemonize no
loglevel notice
databases 16

# ===== 持久化：RDB 快照 =====
# 3600秒内有1次写 / 300秒内有100次写 / 60秒内有10000次写时触发快照
save 3600 1
save 300 100
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# ===== 持久化：AOF 追加日志 =====
appendonly yes
appendfilename "appendonly.aof"
# everysec: 每秒 fsync，兼顾性能与安全
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-use-rdb-preamble yes

# ===== 内存管理 =====
# IM 场景：Session、Token 等数据可再生，优先淘汰最近最少使用的 key
maxmemory 256mb
maxmemory-policy allkeys-lru
# 懒惰删除：大 key 过期/删除异步执行，避免阻塞
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# ===== 慢查询日志 =====
slowlog-log-slower-than 10000
slowlog-max-len 128

# ===== 性能调优 =====
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# ===== 安全 =====
# 开发环境不设密码，生产环境需启用：
# requirepass your-strong-password
# 禁用高危命令（生产环境建议启用）：
# rename-command FLUSHALL ""
# rename-command FLUSHDB  ""
# rename-command DEBUG    ""
