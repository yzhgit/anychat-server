name: Documentation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'cmd/gateway-service/**'
      - 'internal/gateway/**'
      - 'docs/**'
      - 'api/proto/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'cmd/gateway-service/**'
      - 'internal/gateway/**'
      - 'docs/**'
      - 'api/proto/**'

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ç”Ÿæˆå’ŒéªŒè¯æ–‡æ¡£
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Install dependencies
        run: |
          go mod download
          go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate API documentation
        run: |
          swag init \
            -g cmd/gateway-service/main.go \
            --output docs/api/swagger \
            --parseDependency \
            --parseInternal

      - name: Validate swagger.json
        run: |
          if [ ! -f docs/api/swagger/swagger.json ]; then
            echo "Error: swagger.json not generated"
            exit 1
          fi
          echo "âœ“ swagger.json generated successfully"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet docs/api/swagger/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-docs
          path: |
            docs/api/swagger/openapi.json
            docs/api/asyncapi.yaml

      - name: Upload proto artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-proto
          path: api/proto/**/*.proto

      - name: Comment on PR (if docs changed)
        if: github.event_name == 'pull_request' && steps.check_changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“ API documentation has been updated. Please review the changes in `docs/api/swagger/`.'
            })

  # æž„å»ºå’Œéƒ¨ç½²æ–‡æ¡£ç«™ç‚¹åˆ° GitHub Pages
  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: generate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation artifact
        uses: actions/download-artifact@v4
        with:
          name: api-docs
          path: docs/api/swagger/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true # æ·»åŠ è¿™ä¸€è¡Œï¼Œè®© Action è‡ªåŠ¨å¯ç”¨ Pages

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "## Documentation Deployed ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The documentation has been successfully deployed to GitHub Pages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– [View Documentation](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY

  # åŒæ­¥ API å¥‘çº¦åˆ°ç‹¬ç«‹ä»“åº“ï¼Œä¾› SDK/å®¢æˆ·ç«¯é¡¹ç›®æ¶ˆè´¹
  # éœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½® CONTRACTS_REPO_TOKENï¼ˆæœ‰ contracts ä»“åº“å†™æƒé™çš„ PATï¼‰
  # ä»¥åŠ CONTRACTS_REPOï¼ˆæ ¼å¼ï¼šorg/anychat-api-contractsï¼‰
  sync-contracts:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: generate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout backend repo
        uses: actions/checkout@v4

      - name: Download api-docs artifact
        uses: actions/download-artifact@v4
        with:
          name: api-docs
          path: _artifacts/api-docs

      - name: Download proto artifact
        uses: actions/download-artifact@v4
        with:
          name: api-proto
          path: _artifacts/proto

      - name: Checkout contracts repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.CONTRACTS_REPO }}
          token: ${{ secrets.CONTRACTS_REPO_TOKEN }}
          path: _contracts

      - name: Sync files to contracts repo
        run: |
          # åŒæ­¥ OpenAPI è§„æ ¼
          mkdir -p _contracts/http
          cp _artifacts/api-docs/openapi.json _contracts/http/openapi.json

          # åŒæ­¥ AsyncAPI è§„æ ¼
          mkdir -p _contracts/websocket
          cp docs/api/asyncapi.yaml _contracts/websocket/asyncapi.yaml

          # åŒæ­¥ proto æ–‡ä»¶ï¼ˆä»… .protoï¼Œä¸å«ç”Ÿæˆçš„ .pb.goï¼‰
          mkdir -p _contracts/proto
          rsync -av --include="*/" --include="*.proto" --exclude="*" \
            _artifacts/proto/ _contracts/proto/

          # è®°å½•æ¥æºç‰ˆæœ¬
          echo "${{ github.sha }}" > _contracts/.backend-version
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > _contracts/.last-synced

      - name: Commit and push to contracts repo
        run: |
          cd _contracts
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to sync."
          else
            git commit -m "sync: update from anychat-server@${{ github.sha }}"
            git push
          fi

      - name: Summary
        run: |
          echo "## API Contracts Synced" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Synced: \`openapi.json\`, \`asyncapi.yaml\`, \`proto/**\`" >> $GITHUB_STEP_SUMMARY
          echo "Source commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
